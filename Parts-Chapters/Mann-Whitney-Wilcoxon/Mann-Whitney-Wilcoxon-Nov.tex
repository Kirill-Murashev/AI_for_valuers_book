\documentclass[]{scrartcl}

\input{Mann-Whitney-Wilcoxon-Nov-preamble.tex}
%opening
\title{Практическое применение критерия Манна-Уитни-Уилкоксона в~оценочной деятельности}

\author{K.\,A.~{Мурашев}}

\begin{document}

\maketitle
	
\begin{abstract}
	В~своей практике оценщики часто сталкиваются с~необходимостью учёта различий количественных характеристик объектов. В~частности, одной из~стандартных задач является установление признаков, влияющих на~стоимость~(т.\,н.~ценообразующих факторов) и~их~отделение от~признаков, влияние которых на~стоимость отсутствует либо не~может быть установлено. В~практике оценки широкое распространение получил субъективный отбор признаков, учитываемых при~определении стоимости. При~этом конкретные количественные показатели влияния этих признаков на~стоимость зачастую берутся из~т.\,н.~<<справочников>>. Не~отказывая такому подходу в~быстроте и~невысокой стоимости его~реализации, нельзя не~признать, что~только данные, непосредственно наблюдаемые на~открытом рынке, являются надёжной основой суждения о~стоимости. Приоритет таких данных над~прочими, в~частности, полученными путём опроса экспертов, закреплён, в~том~числе в~\href{https://www.rics.org/uk/upholding-professional-standards/sector-standards/valuation/red-book/red-book-global/}{Стандартах оценки~RICS}~\cite{RVGS-2022}, \href{https://www.rics.org/uk/upholding-professional-standards/sector-standards/valuation/red-book/international-valuation-standards/}{Международных стандартах оценки~2022}~\cite{IVS-2022}, а~также \href{https://normativ.kontur.ru/document?moduleId=1&documentId=326168#l0}{МСФО~13~<<Оценка справедливой стоимости}~\cite{MSFO-13}. Поэтому можно говорить о~том, что~математические методы анализа данных, полученных на~открытом рынке, являются наиболее надёжным средством интерпретации рыночной информации, применяемой при~исследованиях рынка и~предсказании стоимости конкретных объектов. В~данном материале будут рассмотрены основные теоретические вопросы, касающиеся теста Манна-Уитни-Уилкоксона~(далее U-тест), а~также проведён пошаговый разбор применения данного теста к~конкретным данным. Материал содержит строки кода, необходимые для~проведения U-теста с~использованием языков программирования Python и~R, а~также приложение в~виде электронной таблицы, содержащей формулы для~проведения данного теста и~полностью готовой для~её~применения на~любых иных данных.
	Данный материал и~все~приложения к~нему распространяются на~условиях лицензии \href{https://creativecommons.org/licenses/by-sa/4.0/}{cc-by-sa-4.0}~\cite{cc-by-sa-4.0}.
\end{abstract}
%
\section{Технические данные}
Данный материал, а~также приложения к~нему доступны по~\href{https://github.com/Kirill-Murashev/AI_for_valuers_book/tree/main/Parts-Chapters/Mann-Whitney-Wilcoxon}{постоянной ссылке}~\cite{Murashev:u-test}. Исходный код данной работы был~создан с~использованием языка~\href{https://www.ctan.org/}{\TeX}~\cite{TeX:site} c~набором макрорасширений~\href{https://www.latex-project.org/}{\LaTeX}~\cite{LaTeX:site}, дистрибутива~\href{https://www.tug.org/texlive/}{TeXLive}~\cite{TeXLive:site} и~редактора~\href{https://www.texstudio.org/}{TeXstudio}~\cite{TeXstudio:site}. Расчёт в~форме электронной таблицы был выполнен с~помощью \href{https://www.libreoffice.org/discover/calc/}{LibreOffice Calc}~\cite{LO:Calc} (Version: 7.3.3.2, Ubuntu package version: 1:7.3.3~rc2-0ubuntu0.20.04.1~lo1 Calc: threaded). Расчёт на~языке~\href{https://www.r-project.org/}{R}~\cite{R_language} (version 4.2.0 (2022-04-22) -- "Vigorous Calisthenics") был выполнен c~использованием IDE~\href{URL}{RStudio} (RStudio 2022.02.2+485 "Prairie Trillium" Release (8acbd38b0d4ca3c86c570cf4112a8180c48cc6fb, 2022-04-19) for Ubuntu Bionic Mozilla/5.0 (X11; Linux x86\_64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.12.8 Chrome/69.0.3497.128 Safari/537.36)~\cite{RStudio:official_site}. Расчёт на~языке \href{https://www.python.org/}{Python}~\cite{Python:site} был выполнен с~использованием среды разработки \href{https://jupyter.org}{Jupyter Lab}~\cite{Jupyter:site}.
%
\section{Предмет исследования}
В~случае работы с~рыночными данными перед оценщиком часто встаёт задача проверки гипотезы о~существенности влияния того или~иного признака, измеренного в~количественной или~порядковой шкале, на~стоимость. Аналогичная задача возникает у~аналитиков рынка недвижимости, специалистов компаний-застройщиков, риелторов. При~этом зачастую отсутствует возможность сбора больших массивов данных, позволяющих применить широкий спектр методов машинного обучения. В~ряде случаев оценщики осознанно сужают область сбора данных до~узкого сегмента рынка, в~результате чего в~их~распоряжении оказываются лишь сверхмалые выборки объёмом менее тридцати наблюдений. При~этом, ценовые данные чаще всего имеют распределение отличное от~нормального. В~данном случае рациональным решением является применение U-теста. Сформулируем задачу:
\begin{itemize}
	\item предположим, что~у~нас~существуют две~выборки удельных цен коммерческих помещений, часть из~которых обладает некоторым признаком (например, имеет отдельный вход), часть "--- нет;
	\item необходимо установить: оказывает~ли наличие этого признака существенное влияние на~удельную стоимость недвижимости данного типа или~нет.
\end{itemize}
На~первый взгляд, согласно сложившейся практике, оценщик может просто субъективно признать те~или~иные признаки значимыми, а~прочие нет, после чего принять значения корректировок на~различия в~этих признаках из~справочников. Однако, как~было сказано выше, такой подход вряд~ли может считаться лучшей практикой, поскольку в~этом случае отсутствует какой-либо серьёзный анализ рынка. Кроме того, в~таком случае вряд~ли можно говорить о~какой-либо ценности такой работы в~принципе.

Вместо этого возможно использовать случайные выборки рыночных данных и~применять к~ним математические методы анализа, позволяющие делать доказательные с~научной точки зрения выводы о~значимости влияния того или~иного признака на~стоимость. Данные, используемые в~настоящей работе, являются вымышленными и~служат для~учебных целей. Прилагаемая электронная таблица настроена таким образом, что~исходные данные могут быть сгенерированы случайным образом, что~позволяет лучше понять поведение теста. 

\section{Основные сведения о~тесте}
В~первую очередь необходимо сказать, что, несмотря на~заявленное общее название, правильнее всё~же говорить о~двух тестах:
\begin{itemize}
	\item \href{http://www.machinelearning.ru/wiki/index.php?title=Критерий_Уилкоксона_двухвыборочный}{двухвыборочный критерий Уилкоксона}, разработанный Фрэнком Уилкоксоном в~1945~году~\cite{MLRU:Wilcoxon-test};
	\item \href{http://www.machinelearning.ru/wiki/index.php?title=Критерий_Уилкоксона-Манна-Уитни}{U-критерий Манна-Уитни}, являющийся дальнейшим развитием вышеуказанном критерия, разработанный Генри Манном и~Дональдом Уитни в~1947~году~\cite{MLRU:Mann-Whitney}.
\end{itemize}
Забегая вперёд, можно сказать о~том, что~статистики данных критериев линейно связаны, а~сами p-значения практически одинаковы, что~с~практической точки зрения позволяет скорее говорить о~вариациях одного теста, а~не~о~двух отдельных~\cite{MLRU:Wilcoxon-test}. В~данной работе по~всему тексту используется общее название, а~также его~сокращённый вариант "--- U-тест, исторический относимый к~критерию Манна-Уитни. Некоторые авторы~\cite{Kobzarq-prikl-mathstat} рекомендуют использовать двухвыборочный критерий Уилкоксона в~случаях, когда нет~предположений о~дисперсиях, а~в~случае равных дисперсий применять U-критерий Манна-Уитни. Однако экспериментальные данные указывают, что~p-значения критериев Уилкоксона и~Манна-Уитни практически совпадают, в~том~числе и~в~случае, когда дисперсии выборок существенно различаются. Придерживаясь принципа KISS~\cite{KISS-principle}, лежащего в~основе всего данного цикла публикаций, автор приходит к~выводу о~возможности применения единого подхода. 

Также следует помнить о~том, что~существует \href{http://www.machinelearning.ru/wiki/index.php?title=Критерий_Уилкоксона_для_связных_выборок}{Критерий Уилкоксона для связных выборок}~\cite{Wilcoxon-signed-rank-test}, представляющий собой отдельный тест, предназначенный для~анализа различий между связанными выборками, тогда как~рассматриваемый в~данной работе U-тест предназначен для~работы с~двумя независимыми выборками.

Предположим, что~заданы две~выборки:
\begin{equation*}
	x^{m} = (x_{1},x_{2},\ldots,x_{m}), x_{i} \in \mathbb{R};\quad y^{n} = (y_{1},y_{2},\ldots,y_{n}), y_{i} \in \mathbb{R} \quad| m \leq n.
\end{equation*}
 
\begin{itemize}
	\item Обе выборки являются простыми, объединённая выборка независима.
	\item Выборки взяты из~неизвестных непрерывных распределений \textit{F(x)} и~\textit{G(y)} соответственно.
\end{itemize}
 
\begin{description}
	\item[Простая выборка "---] это~случайная, однородная, независимая выборка. Эквивалентное определение: выборка ${\textstyle x^{m} = (x_{1},x_{2},\ldots,x_{m})}$ является простой, если значения~${\textstyle (x_{1},x_{2},\ldots,x_{m})}$ являются реализациями \textit{m} независимых одинаково распределённых случайных величин. Иными словами, отбор наблюдений является не~только случайным, но~и~не~предполагает наличия каких-либо специальных правил (например, выбор каждого 10-го наблюдения).
\end{description}
\begin{description}
	\item[U-тест "---] это~непараметрический тест для~проверки нулевой гипотезы, заключающейся в~том, что~для~случайно выбранных из~двух выборок наблюдений ${\textstyle x, x \in X}$ и~${\textstyle y, y \in Y}$ вероятность того, что~\textit{x} больше \textit{y}, равна вероятности того, что~\textit{y} больше~\textit{x}. На~математической языке запись нулевой гипотезы выглядит следующим образом:
	\begin{equation}\label{eq:U-test-null-hypothesis}
	H_{0}:P\{x<y=\frac{1}{2}\}.
	\end{equation}
	Для~целостности теста требуется альтернативная гипотеза, которая заключается в~том, что~вероятность того, что~значение признака наблюдения из~выборки~\textit{X} превышает его~у~наблюдения из~выборки~\textit{Y}, отличается (больше или~меньше) от~вероятности того, что~значение признака у~наблюдения из~\textit{Y} превышает значение у~наблюдения из~\textit{X}. На~математическом языке запись альтернативной гипотезы выглядит следующим образом:
	\begin{equation}\label{eq:U-test-alt-hypothesis}
	H_{1}:P\{x<y\} \neq P\{y<x\} \vee P\{x<y\} + 0.5 \cdot P\{x=y\} \neq 0.5.
	\end{equation}
\end{description}
Согласно базовой концепции U-теста, при~справедливости нулевой гипотезы распределение двух выборок непрерывно, при~справедливости альтернативной распределение одной из~них стохастически больше распределения другой. При~этом, можно сформулировать целый ряд нулевых и~альтернативных гипотез, для~которых данный тест будет давать корректный результат. Его~самое широкое обобщение заключается в~следующих предположениях:
\begin{itemize}
	\item наблюдения в~обеих выборках независимы;
	\item тип данных является как~минимум ранговым, т.\,е.~в~отношении любых двух наблюдений можно сказать, какое из~них~больше;
	\item нулевая гипотеза предполагает, что~распределения двух выборок равны;
	\item альтернативная гипотеза предполагает, что~распределения двух выборок не~равны.
\end{itemize}
Простыми словами, суть U-теста заключается в~том, что~он~позволяет ответить на~вопрос, является~ли существенным различие значения количественного признака двух выборок. Применительно к~оценке можно сказать, что~применение данного теста помогает ответить на~вопрос, является~ли необходимым учёт того или~иного признака в~качестве ценообразующего фактора. Из~сказанного выше следует, что~речь идёт о~двухстороннем тесте. На~практике это~означает, что~тест не~даёт прямой ответ, например на~такой вопрос: <<имеет~ли место значимое превышение удельной стоимости помещений, имеющих отдельный вход, относительно помещений, не~обладающих им>>. Вместо этого корректно говорить о~том, <<существует~ли существенное различие в~значении стоимости между помещениями двух типов: с~отдельным входом и~без~такового>>.

Условиями применения U-теста помимо вышеуказанных требований к~самим выборкам являются:
\begin{itemize}
	\item распределение значений количественного признака выборок отлично от~нормального~(в~противном случае целесообразно использование параметрического t-критерия Стьюдента для~независимых выборок);
	\item не~менее трёх значений признака в~каждой выборке, допускается наличие двух значений в~одной из~выборок, при~условии наличия в~другой не~менее пяти;
	\end{itemize}
    

\section{Практическая реализация}

\section{Выводы}

\printbibliography[title=Источники информации]

\end{document}
