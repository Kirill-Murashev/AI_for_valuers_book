\documentclass[]{scrartcl}

\input{Mann-Whitney-Wilcoxon-Nov-preamble.tex}
%opening
\title{Практическое применение критерия Манна-Уитни-Уилкоксона в~оценочной деятельности}

\author{K.\,A.~{Мурашев}}

\begin{document}

\maketitle
	
\begin{abstract}
	В~своей практике оценщики часто сталкиваются с~необходимостью учёта различий количественных характеристик объектов. В~частности, одной из~стандартных задач является установление признаков, влияющих на~стоимость~(т.\,н.~ценообразующих факторов) и~их~отделение от~признаков, влияние которых на~стоимость отсутствует либо не~может быть установлено. В~практике оценки широкое распространение получил субъективный отбор признаков, учитываемых при~определении стоимости. При~этом конкретные количественные показатели влияния этих признаков на~стоимость зачастую берутся из~т.\,н.~<<справочников>>. Не~отказывая такому подходу в~быстроте и~невысокой стоимости его~реализации, нельзя не~признать, что~только данные, непосредственно наблюдаемые на~открытом рынке, являются надёжной основой суждения о~стоимости. Приоритет таких данных над~прочими, в~частности, полученными путём опроса экспертов, закреплён, в~том~числе в~\href{https://www.rics.org/uk/upholding-professional-standards/sector-standards/valuation/red-book/red-book-global/}{Стандартах оценки~RICS}~\cite{RVGS-2022}, \href{https://www.rics.org/uk/upholding-professional-standards/sector-standards/valuation/red-book/international-valuation-standards/}{Международных стандартах оценки~2022}~\cite{IVS-2022}, а~также \href{https://normativ.kontur.ru/document?moduleId=1&documentId=326168#l0}{МСФО~13~<<Оценка справедливой стоимости}~\cite{MSFO-13}. Поэтому можно говорить о~том, что~математические методы анализа данных, полученных на~открытом рынке, являются наиболее надёжным средством интерпретации рыночной информации, применяемой при~исследованиях рынка и~предсказании стоимости конкретных объектов. В~данном материале будут рассмотрены основные теоретические вопросы, касающиеся теста Манна-Уитни-Уилкоксона~(далее U-тест), а~также проведён пошаговый разбор применения данного теста к~реальным данным. Материал содержит строки кода, необходимые для~проведения U-теста с~использованием языков программирования Python и~R, а~также приложение в~виде электронной таблицы, содержащей тестовые данные и~формулы для~проведения рассматриваемого теста и~полностью готовой для~её~применения на~любых иных данных.
	Данный материал и~все~приложения к~нему распространяются на~условиях лицензии \href{https://creativecommons.org/licenses/by-sa/4.0/}{cc-by-sa-4.0}~\cite{cc-by-sa-4.0}.
\end{abstract}
%
\tableofcontents
%
\section{Технические данные}
Данный материал, а~также приложения к~нему доступны по~\href{https://github.com/Kirill-Murashev/AI_for_valuers_book/tree/main/Parts-Chapters/Mann-Whitney-Wilcoxon}{постоянной ссылке}~\cite{Murashev:u-test}. Исходный код данной работы был~создан с~использованием языка~\href{https://www.ctan.org/}{\TeX}~\cite{TeX:site} c~набором макрорасширений~\href{https://www.latex-project.org/}{\LaTeX}~\cite{LaTeX:site}, дистрибутива~\href{https://www.tug.org/texlive/}{TeXLive}~\cite{TeXLive:site} и~редактора~\href{https://www.texstudio.org/}{TeXstudio}~\cite{TeXstudio:site}. Расчёт в~форме электронной таблицы был выполнен с~помощью \href{https://www.libreoffice.org/discover/calc/}{LibreOffice Calc}~\cite{LO:Calc} (Version: 7.3.3.2, Ubuntu package version: 1:7.3.3~rc2-0ubuntu0.20.04.1~lo1 Calc: threaded). Расчёт на~языке~\href{https://www.r-project.org/}{R}~\cite{R_language} (version 4.2.0 (2022-04-22) -- "Vigorous Calisthenics") был выполнен c~использованием IDE~\href{URL}{RStudio} (RStudio 2022.02.2+485 "Prairie Trillium" Release (8acbd38b0d4ca3c86c570cf4112a8180c48cc6fb, 2022-04-19) for Ubuntu Bionic Mozilla/5.0 (X11; Linux x86\_64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.12.8 Chrome/69.0.3497.128 Safari/537.36)~\cite{RStudio:official_site}. Расчёт на~языке \href{https://www.python.org/}{Python}~(Version~3.8.10)~\cite{Python:site} был выполнен с~использованием среды разработки \href{https://jupyter.org}{Jupyter Lab} (Version 3.4.2)~\cite{Jupyter:site}.
%
\section{Предмет исследования}
В~случае работы с~рыночными данными перед оценщиком часто встаёт задача проверки гипотезы о~существенности влияния того или~иного признака, измеренного в~количественной или~порядковой шкале, на~стоимость. Аналогичная задача возникает у~аналитиков рынка недвижимости, специалистов компаний-застройщиков, риелторов. При~этом зачастую отсутствует возможность сбора больших массивов данных, позволяющих применить широкий спектр методов машинного обучения. В~ряде случаев оценщики осознанно сужают область сбора данных до~узкого сегмента рынка, в~результате чего в~их~распоряжении оказываются лишь сверхмалые выборки объёмом менее тридцати наблюдений. При~этом, ценовые данные чаще всего имеют распределение отличное от~нормального. В~данном случае рациональным решением является применение U-теста. Сформулируем задачу:
\begin{itemize}
	\item предположим, что~у~нас~существуют две~выборки удельных цен коммерческих помещений, часть из~которых обладает некоторым признаком (например, имеет отдельный вход), часть "--- нет;
	\item необходимо установить: оказывает~ли наличие этого признака существенное влияние на~удельную стоимость недвижимости данного типа или~нет.
\end{itemize}
На~первый взгляд, согласно сложившейся практике, оценщик может просто субъективно признать те~или~иные признаки значимыми, а~прочие нет, после чего принять значения корректировок на~различия в~этих признаках из~справочников. Однако, как~было сказано выше, такой подход вряд~ли может считаться лучшей практикой, поскольку в~этом случае отсутствует какой-либо серьёзный анализ рынка. Кроме того, в~таком случае вряд~ли можно говорить о~какой-либо ценности такой работы в~принципе.

Вместо этого возможно использовать случайные выборки рыночных данных и~применять к~ним математические методы анализа, позволяющие делать доказательные с~научной точки зрения выводы о~значимости влияния того или~иного признака на~стоимость. Данные, используемые в~настоящей работе при~проведении U-теста средствами Python и~R, представляют собой реальные рыночные данные, часть из~которых была собрана автором путём парсинга, часть "--- предоставлена коллегами для~анализа. Прилагаемая электронная таблица настроена таким образом, что~исходные данные могут быть сгенерированы случайным образом.

\section{Основные сведения о~тесте}
\subsection{Предпосылки и~формализация гипотез}
В~первую очередь необходимо сказать, что, несмотря на~заявленное общее название, правильнее всё~же говорить о~двух тестах:
\begin{itemize}
	\item \href{http://www.machinelearning.ru/wiki/index.php?title=Критерий_Уилкоксона_двухвыборочный}{двухвыборочный критерий Уилкоксона}, разработанный Фрэнком Уилкоксоном в~1945~году~\cite{MLRU:Wilcoxon-test};
	\item \href{http://www.machinelearning.ru/wiki/index.php?title=Критерий_Уилкоксона-Манна-Уитни}{U-критерий Манна-Уитни}, являющийся дальнейшим развитием вышеуказанном критерия, разработанный Генри Манном и~Дональдом Уитни в~1947~году~\cite{MLRU:Mann-Whitney}.
\end{itemize}
Забегая вперёд, можно сказать о~том, что~статистики данных критериев линейно связаны, а~сами p-значения практически одинаковы, что~с~практической точки зрения позволяет скорее говорить о~вариациях одного теста, а~не~о~двух отдельных~\cite{MLRU:Wilcoxon-test}. В~данной работе по~всему тексту используется общее название, а~также его~сокращённый вариант "--- U-тест, исторический относимый к~критерию Манна-Уитни. Некоторые авторы~\cite{Kobzarq-prikl-mathstat} рекомендуют использовать двухвыборочный критерий Уилкоксона в~случаях, когда нет~предположений о~дисперсиях, а~в~случае равных дисперсий применять U-критерий Манна-Уитни. Однако экспериментальные данные указывают, что~p-значения критериев Уилкоксона и~Манна-Уитни практически совпадают, в~том~числе и~в~случае, когда дисперсии выборок существенно различаются. Придерживаясь принципа KISS~\cite{KISS-principle}, лежащего в~основе всего данного цикла публикаций, автор приходит к~выводу о~возможности применения единого подхода. 

Также следует помнить о~том, что~существует \href{http://www.machinelearning.ru/wiki/index.php?title=Критерий_Уилкоксона_для_связных_выборок}{Критерий Уилкоксона для связных выборок}~\cite{Wilcoxon-signed-rank-test}, представляющий собой отдельный тест, предназначенный для~анализа различий между связанными выборками, тогда как~рассматриваемый в~данной работе U-тест предназначен для~работы с~двумя независимыми выборками.

Предположим, что~заданы две~выборки:
\begin{equation*}
	x^{m} = (x_{1},x_{2},\ldots,x_{m}), x_{i} \in \mathbb{R};\quad y^{n} = (y_{1},y_{2},\ldots,y_{n}), y_{i} \in \mathbb{R} \quad| m \leq n.
\end{equation*}
 
\begin{itemize}
	\item Обе выборки являются простыми, объединённая выборка независима.
	\item Выборки взяты из~неизвестных непрерывных распределений \textit{F(x)} и~\textit{G(y)} соответственно.
\end{itemize}
 
\begin{description}
	\item[Простая выборка "---] это~случайная, однородная, независимая выборка. Эквивалентное определение: выборка ${\textstyle x^{m} = (x_{1},x_{2},\ldots,x_{m})}$ является простой, если значения~${\textstyle (x_{1},x_{2},\ldots,x_{m})}$ являются реализациями \textit{m} независимых одинаково распределённых случайных величин. Иными словами, отбор наблюдений является не~только случайным, но~и~не~предполагает наличия каких-либо специальных правил (например, выбор каждого 10-го наблюдения).
\end{description}
\begin{description}
	\item[U-тест "---] это~непараметрический тест для~проверки нулевой гипотезы, заключающейся в~том, что~для~случайно выбранных из~двух выборок наблюдений ${\textstyle x, x \in X}$ и~${\textstyle y, y \in Y}$ вероятность того, что~\textit{x} больше \textit{y}, равна вероятности того, что~\textit{y} больше~\textit{x}. На~математической языке запись нулевой гипотезы выглядит следующим образом:
	\begin{equation}\label{eq:U-test-null-hypothesis}
	H_{0}:P\{x<y=\frac{1}{2}\}.
	\end{equation}
	Для~целостности теста требуется альтернативная гипотеза, которая заключается в~том, что~вероятность того, что~значение признака наблюдения из~выборки~\textit{X} превышает его~у~наблюдения из~выборки~\textit{Y}, отличается (больше или~меньше) от~вероятности того, что~значение признака у~наблюдения из~\textit{Y} превышает значение у~наблюдения из~\textit{X}. На~математическом языке запись альтернативной гипотезы выглядит следующим образом:
	\begin{equation}\label{eq:U-test-alt-hypothesis}
	H_{1}:P\{x<y\} \neq P\{y<x\} \vee P\{x<y\} + 0.5 \cdot P\{x=y\} \neq 0.5.
	\end{equation}
\end{description}
Согласно базовой концепции U-теста, при~справедливости нулевой гипотезы распределение двух выборок непрерывно, при~справедливости альтернативной распределение одной из~них стохастически больше распределения другой. При~этом, можно сформулировать целый ряд нулевых и~альтернативных гипотез, для~которых данный тест будет давать корректный результат. Его~самое широкое обобщение заключается в~следующих предположениях:
\begin{itemize}
	\item наблюдения в~обеих выборках независимы;
	\item тип данных является как~минимум ранговым, т.\,е.~в~отношении любых двух наблюдений можно сказать, какое из~них~больше;
	\item нулевая гипотеза предполагает, что~распределения двух выборок равны;
	\item альтернативная гипотеза предполагает, что~распределения двух выборок не~равны.
\end{itemize}
В~случае более строгого набора допущений, чем~приведённые выше, например, в~случае допущения о~том, что~распределение двух выборок в~случае справедливости нулевой гипотезы непрерывно, альтернативной "--- имеет сдвиг расположения двух распределений, т.\,е.~$f_{1}{x}=f_{2}(x+\sigma)$, можно сказать, что~U-тест представляет собой тест на~проверку гипотезы о~равенстве медиан. В~этом случае, U-тест можно интерпретировать как~проверку того, отличается~ли от~нуля оценка Ходжеса-Лемана разницы значений мер центральной тенденции. В~данной ситуации оценка Ходжеса-Лемана представляет собой медиану всех возможных значений различий между наблюдениями в~первой и~второй выборках. Вместе с~тем, если и~дисперсии, и~формы распределения обеих выборок различаются, U-тест не~может корректно проверить медианы. Можно показать примеры, когда медианы численно равны, при~этом тест отвергает нулевую гипотезу с~вследствие малого p-значения.

Таким образом, более корректной интерпретацией U-теста является его~использование для~проверки именно \href{http://www.machinelearning.ru/wiki/index.php?title=Гипотеза_сдвига}{гипотезы сдвига}~\cite{MLRU:shift-hypothesis}.
\begin{description}
	\item[Гипотеза сдвига "---] статистическая гипотеза, часто рассматривающаяся как~альтернатива гипотезе о~полной однородности выборок. Пусть даны две выборки данных. Пусть также даны две случайные величины \textit{X} и~\textit{Y}, которые распределены как~элементы этих выборок и~имеют функции распределения \textit{F(x)} и~\textit{G(y)} соответственно. В~этих терминах гипотезу сдвига можно записать следующим образом: 
	\begin{equation}
		H:F(x)=G(x+\sigma) \quad| \forall x,\ \sigma \neq 0.
	\end{equation}
\end{description}
В~этом случае U-критерий является состоятельным независимо от~особенностей выборок.

Простыми словами, суть U-теста заключается в~том, что~он~позволяет ответить на~вопрос, является~ли существенным различие значения количественного признака двух выборок. Применительно к~оценке можно сказать, что~применение данного теста помогает ответить на~вопрос, является~ли необходимым учёт того или~иного признака в~качестве ценообразующего фактора. Из~сказанного выше следует, что~речь идёт о~двухстороннем тесте. На~практике это~означает, что~тест не~даёт прямой ответ, например на~такой вопрос: <<имеет~ли место значимое превышение удельной стоимости помещений, имеющих отдельный вход, относительно помещений, не~обладающих им>>. Вместо этого корректно говорить о~том, <<существует~ли существенное различие в~значении стоимости между помещениями двух типов: с~отдельным входом и~без~такового>>.

Условиями применения U-теста помимо вышеуказанных требований к~самим выборкам являются:
\begin{itemize}
	\item распределение значений количественного признака выборок отлично от~нормального~(в~противном случае целесообразно использование параметрического t-критерия Стьюдента для~независимых выборок);
	\item не~менее трёх значений признака в~каждой выборке, допускается наличие двух значений в~одной из~выборок, при~условии наличия в~другой не~менее пяти.
	\end{itemize}
Подытоживая вышесказанное, можно сказать, что~существуют три~варианта нулевой гипотезы, в~зависимости от~уровня строгости.
\begin{table}[ht]
	\caption{Варианты нулевой гипотезы при~использовании U-теста при~оценке стоимости}  \label{tab:nul-hypothesis-variants}
	\centering
	\begin{tabularx}{\textwidth}{p{0.35\linewidth} p{0.6\linewidth}} 
		\hline
		Тип гипотезы&Формулировка\\
		 \hline
		Научная&Наблюдения из~двух выборок полностью однородны, т.\,е.~принадлежат одному распределению, сдвиг отсутствует, оценка, сделанная для~первой выборки, является несмещённой и~для~второй\\
		 \hline
		Практическая&Медианы двух выборок равны между собой\\
		 \hline
		Изложенная в~терминах оценки&Различие признака между двумя выборками объектов-аналогов не~является существенным, его~учёт не~требуется, данный признак не~является ценообразующим фактором\\ \hline
	\end{tabularx}
\end{table}
\subsection{Реализация теста}
\subsubsection{Статистика критерия}
Допустим, что~элементы ${\textstyle x_{1},\ldots,x_{n}}$ представляют собой простую независимую выборку из~множества~${\textstyle X \in \mathbb{R}}$, а~элементы ${\textstyle y_{1},\ldots,y_{n}}$ представляют собой простую независимую выборку из~множества~${\textstyle Y \in \mathbb{R}}$, при~этом выборки являются независимыми относительно друг друга. Тогда соответствующая U-статистика определяется следующим образом:
\begin{equation}\label{eq:U-statistic-base-formula}
	\begin{aligned}
	U&=\sum_{i=1}^{m} \sum_{j=1}^{n} S (x_{i},y_{j}),\\
	&\text{при}\\
	S(x,y)&=
	\begin{cases}
	1,\quad \text{если}\ x>y,\\
	\frac{1}{2},\quad \text{если}\ x=y,\\
	0,\quad \text{если}\ x<y.
	\end{cases}
	\end{aligned}
\end{equation}
\subsubsection{Методы вычисления}
Тест предполагает вычисление статистики, обычно называемой U-статистикой, распределение которой известно в~случае справедливости нулевой гипотезы. При~работе со~сверхмалыми выборками распределение задаётся таблично, при~размерах выборки более двадцати наблюдений оно~достаточно хорошо аппроксимируется нормальным распределением. Существуют два~методы вычисления U-статистики: подсчёт вручную по~формуле~\ref{eq:U-statistic-base-formula}, применение специального алгоритма. Первый способ подходит только для~сверхмалых выборок в~силу трудоёмкости. Второй способ может быть формализован в~виде пошагового набора инструкций и~будет описан далее.
\begin{enumerate}
	\item Необходимо построить общий вариационный ряд для~двух выборок, а~затем присвоить каждому наблюдению ранг, начиная с~1 для~наименьшего из~них. В~случае наличия связок, т.\,e.~групп повторяющихся значений (такой группой могут являться в~т.\,ч.~только два равных значения), каждому наблюдению из~такой группы присваивается значение, равное медиане значений рангов группы до~корректировки (например, в~случае вариационного ряда (\textit{3, 5, 5, 5, 5, 8}) ранги до~корректировки имеют вид (\textit{1, 2, 3, 4, 5, 6}) после "--- (\textit{1, 3.5, 3.5, 3.5, 3.5, 6})).
	%
	\item Необходимо провести подсчёт сумм рангов наблюдений каждой из~выборок, обозначаемых как~${\textstyle R_{1},\ R_{2}}$ соответственно. При~этом, общая сумма рангов~\textit{R} может быть вычислена по~формуле
	\begin{equation}\label{eq:common-R}
	R = \frac{N(N+1)}{2},
	\end{equation}
	где~\textit{N} "--- общее число наблюдений в~обеих выборках.
	%
	\item Далее вычисляем U-значение для~первой выборки:
	\begin{equation}\label{eq:U1}
	U_{1}=R_{1}-\frac{n_{1}(n_{1}+1)}{2},
	\end{equation}
	где ${\textstyle R_{1}}$ "--- сумма рангов первой выборки, ${\textstyle n_{1}}$ "--- число наблюдений в~первой выборке.
	
	Аналогичным образом вычисляется U-значения для~второй выборки:
	\begin{equation}\label{eq:U2}
	U_{2}=R_{2}-\frac{n_{2}(n_{2}+1)}{2},
	\end{equation}
	где ${\textstyle R_{2}}$ "--- сумма рангов второй выборки, ${\textstyle n_{2}}$ "--- число наблюдений во~второй выборке.
	
	Из~вышеприведённых формул следует, что
	\begin{equation}\label{eq:U1-U2-relation}
	U_{1}+U_{2} = R_{1}-\frac{n_{1}(n_{1}+1)}{2} + R_{2}-\frac{n_{2}(n_{2}+1)}{2}.
	\end{equation}
	Также известно, что
	\begin{equation}\label{eq:R-N-relation}
	\begin{cases}
	R_{1}+R_{2}=\dfrac{N(N+1)}{2}\\
	N=n_{1}+n_{2}.
	\end{cases}
	\end{equation}
	Тогда
	\begin{equation}\label{eq:check-U-value}
	U_{1}+U_{2}=n_{1}n{2}.
	\end{equation}
	Использование данной формулы в~качестве контрольного соотношения может быть полезно для~проверки корректности вычислений при~расчёте в~табличном процессоре.
	%
	\item Из~двух значений ${\textstyle U_{1},\ U_{2}}$ во~всех случаях выбираем меньшее, которое и~будет являться U-статистикой и~использоваться в~дальнейших расчётах. Обозначим его~как~\textit{U}.
\end{enumerate}
\subsubsection{Интерпретация результата}
Для~корректной интерпретации результата теста необходимо указать:
\begin{itemize}
	\item размеры выборок;
	\item значения меры центральной тенденции для~каждой выборки (с~учётом непараметрического характера теста, подходящей мерой центральной тенденции представляется медиана);
	\item значение самой U-статистики;
	\item показатель \href{https://en.wikipedia.org/wiki/Effect_size#Common_language_effect_size}{CLES}~\cite{Wiki:CLES};
	\item \href{https://en.wikipedia.org/wiki/Effect_size#Rank-biserial_correlation}{рангово-бисериальный коэффициент корреляции~(RBC)}~\cite{Wiki:rank-biserial-correlation};
	\item принятый уровень значимости (как~правило~0.05).
\end{itemize}
Понятие U-статистики было рассмотрено ранее, большинство других показателей широко известны и~не~требуют какого-либо отдельного рассмотрения. Остановимся на~показателях CLES и~RBC.
\paragraph{Показатель CLES}
\begin{description}
		\item[Common language effect size~(CLES) "---] вероятность того, что~значение случайно выбранного наблюдения из~первой группы больше значения случайно выбранного наблюдения из~второй группы. Данный показатель вычисляется по~формуле
		\begin{equation}\label{eq:CLES}
		CLES = \frac{U_{1}}{n_{1}n_{2}}.
		\end{equation}
		Вместо обозначения \textit{CLES} часто используется обозначение \textit{f~(favorable)}. Данное выборочное значение является несмещённой оценкой значения для~всей совокупности объектов, принадлежащих множеству.
\end{description}
Следует отметить, что~значение и~смысл данного показателя эквивалентны значению и~смыслу показателя~\href{https://en.wikipedia.org/wiki/Receiver_operating_characteristic}{AUC}\cite{Wiki:ROC}. Таким образом, можно говорить о~том, что
\begin{equation}\label{eq:AUC}
CLES = f = AUC_{1} = f = \frac{U_{1}}{n_{1}n_{2}}.
\end{equation}
\paragraph{Рангово-бисериальная корреляция}
Метод представления степени влияния для~U-теста заключается в~использовании меры ранговой корреляции, известной как~рангово-бисериальная корреляция. Как~и~в~случае с~иными мерами корреляции значение коэффициента рангово-бисериальной корреляции может принимать значения в~диапазоне~${\textstyle [-1;1]}$, при~этом нулевое значение означает отсутствие какой-либо связи. Коэффициент рангово-бисериальной корреляции обычно обозначает как~\textit{r}. Для~его вычисления используется простая формула, основанная на~значении~CLES. Выдвинем гипотезу о~том, что~в~паре случайных наблюдений, одно~из~которых взято из~первой выборки, другое "--- из~второй, значение первого больше. Запишем её~на~математическом языке:
\begin{equation}\label{eq:RBC-hypothesis}
H: x_{i} > y{j} \quad x \ in X,\ y \in Y.
\end{equation} 
Тогда значение коэффициента рангово-бисериальной корреляции представляет собой разницу между долей случайных пар наблюдений, удовлетворяющей~(\foreignlanguage{english}{favorable}) гипотезе "--- \textit{f}, и~комплементарной ей~доле случайных пар, не~удовлетворяющих~(\foreignlanguage{english}{unfavorable}) гипотезе "--- \textit{u}. По~сути, данная формула представляет собой формулу разности между показателями~CLES для~каждой из~групп.
\begin{equation}\label{eq:RBC-formula-1}
r = f - u = CLES_{1} - CLES_{2} = f - (1 - f)
\end{equation}
Существует также ряд альтернативных формул, дающих идентичный результат:
\begin{equation}\label{eq:RBC-formula-2}
r = 2f -1 = \frac{2U_{1}}{n_{1}n_{2}}-1 = 1 - \frac{2U_{2}}{n_{1}n_{2}}.
\end{equation}	
\subsubsection{Вычисление p-значения и~итоговая проверка нулевой гипотезы}
При~достаточном большом числе наблюдений в~каждой выборке, значение U-статистики имеет приблизительно нормальное распределение. Тогда её~\href{https://en.wikipedia.org/wiki/Standard_score}{стандартизированное значение} (z-метка, \foreignlanguage{english}{z-score})~\cite{Wiki:z-score} может быть вычислено по~формуле
\begin{equation}\label{eq:z-score}
z = \frac{U-m_{U}}{\sigma_{U}},
\end{equation}
где~${\textstyle m_{U}}$ "--- среднее арифметическое~\textit{U}, ${\textstyle \sigma_{U}}$ "--- её~стандартное отклонение. Визуализация понятия стандартизированное значения для~нормального распределения приведена на~рисунке~\ref{fig:z-score}.
\begin{figure}[ht]
	\centering
	\includegraphics[width=0.8\textwidth]{The_Normal_Distribution.pdf}
	\caption{Визуализация понятия стандартизированного значения~(z-score) для~нормального распределения \cite{Wiki:z-score}}\label{fig:z-score}
\end{figure}
Среднее для~\textit{U} вычисляется по~формуле
\begin{equation}\label{eq:U-mean}
m_{U} = \frac{n_{1}n_{2}}{2}.
\end{equation}
Формула стандартного отклонения в~случае отсутствия связок выглядит следующим образом:
\begin{equation}\label{eq:standard-deviation-no-ties}
\sigma_{U} =  \sqrt{\frac{n_{1}n_{2}(n_{1}+n_{2}+1)}{12}}.
\end{equation}
В~случае наличия связок используется другая формула:
\begin{equation}\label{eq:standard-deviation-ties}
\sigma_{U_{ties}} = \sqrt{\frac{n_{1}n_{2}(n_{1}+n_{2}+1)}{12} - \frac{n_{1}n_{2}\sum_{k=1}^{K}({t_{k}}^{3} - t_{k})}{12n(n-1)}} = \sqrt{\frac{n_{1}n_{2}}{12} \left((n+1)-\frac{\sum_{k=1}^{K}({t_{k}}^{3} - t_{k})}{n(n-1)}\right)},
\end{equation}
где~${\textstyle t_{k}}$ "--- количество наблюдений, имеющих ранг~\textit{k}, \textit{K} "--- общее число рангов, имеющих связки.
Далее, получив стандартизированное значение~(z-score), и~используя аппроксимацию стандартного нормального распределения, вычисляется \textit{p-значение} для~заданного уровня значимости (как~правило 0.05). Интерпретация результата осуществляется следующим образом:
\begin{equation}\label{eq:p-interpretation}
	\begin{aligned}
	p &< 0.05 \Rightarrow \text{нулевая гипотеза отклоняется}\\
	p &\geq 0.05 \Rightarrow \text{нулевая гипотеза не может быть отклонена}.
	\end{aligned}
\end{equation}
\section{Практическая реализация}
\subsection{Реализация в~табличном процессоре LibreOffice Calc}
На~данный момент можно c~уверенностью сказать, что~табличные процессоры являются стандартом для~расчётов оценщиков. Проникновение средств разработки, например на~языке Python либо~R, в~профессиональную деятельность оценщиков идёт достаточно медленно. Кроме того, самостоятельный пошаговый расчёт позволяет лучше понять методику U-теста. Поэтому было принято решение создать пошаговую инструкцию для~проведения U-теста в~электронной таблице. Для~этого был использован программный продукт LibreOffice Calc~(Version: 7.3.3.2, Ubuntu package version: 1:7.3.3~rc2-0ubuntu0.20.04.1~lo1 Calc: threaded), существенная часть функционала которого имеется также и~в~наиболее распространённом приложении такого рода Microsoft Excel. Отсутствуют основания полагать, что~сделанные расчёты не~будут корректно работать в~приложениях, отличных от~LibreOffice Calc. Однако гарантировать это~также невозможно. Для~однозначно корректного проведения теста рекомендуется использовать именно данное приложение, имеющее версии для~всех основных операционных систем. Актуальная версия файла~\href{https://github.com/Kirill-Murashev/AI_for_valuers_book/blob/main/Parts-Chapters/Mann-Whitney-Wilcoxon/U-test.ods}{U-test.ods} находится в~\href{https://github.com/Kirill-Murashev/AI_for_valuers_book/tree/main/Parts&Chapters/Mann-Whitney-Wilcoxon}{репозитории} вместе с~остальными материалами данной работы.

Данные, рассматриваемые в~данной подсекции, являются вымышленными и~были созданы алгоритмом генерации псевдослучайных чисел LibreOffice Calc. Для~повторной генерации необходимо использовать сочетание клавиш \emph{ctrl+shift+F9}. 

Рассмотрим учебную задачу. В~ячейках I3:J30 содержатся данные значений некоторого количественного признака для~двух выборок, взятых из~множеств \textit{I} и~\textit{J} соответственно. Различие между элементами этих множеств заключается в~наличии некоторого признака у~элементов множества \textit{I} и~его~отсутствия у~элементов множества \textit{J}. Задача заключается в~проверке гипотезы о~том, что~различие в~данном признаке следует признать существенным, а~сам признак является ценообразующим фактором. Выдвинем нулевую гипотезу, сформулировав её~в~трёх вариантах, соответствующих трём уровням строгости, описанным ранее в~таблице~\ref{tab:nul-hypothesis-variants}. Следует отметить, что~U-тест основан на~т.\,н.~\emph{частотном подходе к~вероятности} (о~различиях между \emph{частотным} и~\emph{байесовским} подходом к~вероятности применительно к~оценке стоимости можно прочитать, в~частности в~\cite{Murashev:freq-baye-prob}). Как~известно, частотный подход базируется на~предпосылке о~том, что случайность является следствием объективной неопределённости, которая может быть уменьшена только путём проведения серии экспериментов. В частотном подходе существует чёткое разделение на~случайные и~неслучайные параметры. Типичной задачей является оценка тех~или~иных параметров генеральной совокупности, представляющей собой набор случайных величин на~основе детерминированных параметров выборки, например: среднее, мода, дисперсия и~т.\,д. Последние представляют собой конкретные значения, в~которых уже~нет~никакой случайности.

\section{Выводы}

\printbibliography[title=Источники информации]

\end{document}
